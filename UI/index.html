<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Proyecto Final Martin Camacho</title>
        <!-- Bootstrap Styles-->
        <link href="assets/css/bootstrap.css" rel="stylesheet" />
        <!-- FontAwesome Styles-->
        <link href="assets/css/font-awesome.css" rel="stylesheet" />
        <!-- Morris Chart Styles-->
        <link href="assets/js/morris/morris-0.4.3.min.css" rel="stylesheet" />
        <!-- Custom Styles-->
        <link href="assets/css/custom-styles.css" rel="stylesheet" />
        <!-- Google Fonts-->
        <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />
        <script src="assets/js/angular.min.js"></script>
    </head>

    <body>
        <div id="wrapper" ng-app="index" ng-controller="index_ctrl">
            <nav class="navbar navbar-default top-navbar" role="navigation">

                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="index.html">Camachosoft</a>
                </div>

                <ul class="nav navbar-top-links navbar-right">
                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="false">
                            <i class="fa fa-bell fa-fw"></i> <i class="fa fa-caret-down"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-alerts">
                            <li>
                                <a href="#">
                                    <div>
                                        <i class="fa fa-comment fa-fw"></i> New Comment
                                        <span class="pull-right text-muted small">4 min</span>
                                    </div>
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a href="#">
                                    <div>
                                        <i class="fa fa-twitter fa-fw"></i> 3 New Followers
                                        <span class="pull-right text-muted small">12 min</span>
                                    </div>
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a href="#">
                                    <div>
                                        <i class="fa fa-envelope fa-fw"></i> Message Sent
                                        <span class="pull-right text-muted small">4 min</span>
                                    </div>
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a href="#">
                                    <div>
                                        <i class="fa fa-tasks fa-fw"></i> New Task
                                        <span class="pull-right text-muted small">4 min</span>
                                    </div>
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a href="#">
                                    <div>
                                        <i class="fa fa-upload fa-fw"></i> Server Rebooted
                                        <span class="pull-right text-muted small">4 min</span>
                                    </div>
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a class="text-center" href="#">
                                    <strong>See All Alerts</strong>
                                    <i class="fa fa-angle-right"></i>
                                </a>
                            </li>
                        </ul>
                        <!-- /.dropdown-alerts -->
                    </li>
                    <!-- /.dropdown -->
                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="false">
                            <i class="fa fa-user fa-fw"></i> <i class="fa fa-caret-down"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-user">
                            <li><a href="#"><i class="fa fa-user fa-fw"></i> User Profile</a>
                            </li>
                            <li><a href="#"><i class="fa fa-gear fa-fw"></i> Settings</a>
                            </li>
                            <li class="divider"></li>
                            <li><a href="#"><i class="fa fa-sign-out fa-fw"></i> Logout</a>
                            </li>
                        </ul>
                        <!-- /.dropdown-user -->
                    </li>
                    <!-- /.dropdown -->
                </ul>
            </nav>
            <!--/. NAV TOP  -->
            <nav class="navbar-default navbar-side" role="navigation"  >
                <div class="sidebar-collapse" >
                    <ul class="nav"  id="main-menu" ng-repeat="x in menu2"  >

                        <li id={{x.id}} name= {{x.nombre}} ng-click="toggleTables($event)">
                            <a class="active-menu"  href="#"><i class="fa fa-dashboard"></i> Pagos</a>
                        </li>
                    </ul>
                </div>
            </nav>
            <!-- /. NAV SIDE  -->
            <div id="page-wrapper">
                <div id="page-inner">

                    <!-- /. ROW  -->
                    <div class="row all_fracs_table" >
                        
                        <div class="col-md-12 col-sm-12 col-xs-12" >
                            <div class="panel panel-default">
                                <div class=" panel-heading dataTables_wrapper form-inline">
									<div class="row">
										<div class="col-sm-6">
											<div class="dataTables_length" id="dataTables-example_length">
												<label>
												Fraccionamiento:
													 <select ng-model="myFrac" ng-options="frac.nombre for frac in allFracs"></select>
												</label>
											</div>
										</div>
										<div class="col-sm-6">
											<div id="dataTables-example_filter" class="dataTables_filter">
												<label>
													Expediente:
													<input type="text" id="expText" class="form-control input-sm" aria-controls="dataTables-example">
													<button class="btn btn-default" ng-click="buscar()"><i class=" fa fa-search "></i> Buscar</button>
												</label>
											</div>
										</div>
									</div>
								</div> 
								
								
								
								
								<div class=" panel-heading  ">
									
										<div class="panel-body"> 
											<div class="alert alert-info col-md-5">
												<strong>Titular: </strong> {{titular}}
											</div>
											<div class="alert alert-success col-md-3">
												<strong>S. Corriente: </strong> ${{saldoCorriente}}
											</div>
											<div class="alert alert-danger col-md-3">
												<strong>S. Vencido: </strong>${{saldoVencido}}
											</div>
										</div>
									
								</div> 

                                <div class="panel-body">
                                    <div class="table-responsive" >
                                        <table class="table table-striped table-bordered table-hover" id="tablaFraccs">
                                            <thead>
                                                <tr >  
                                                    
                                                    <th style="text-align:center;">Mto.</th>
													<th style="text-align:center;">F. Vencimiento</th>
													<th style="text-align:center;">Importe</th>
													<th style="text-align:center;">Saldo</th>
													<th style="text-align:center;">F. Pago</th>
                                                    <th class="text-center"> </th>
                                                </tr>
                                            </thead>
                                            <tbody ng-repeat="x in movimientos track by $index">

                                                <tr>
                                                   
												   <td class="text-center">
                                                        {{x.noMovimiento}}
                                                    </td>
													<td class="text-center">
                                                        {{x.fechaVencimiento}}
                                                    </td>
													<td class="text-center">
                                                        {{x.importe}}
                                                    </td>
													<td class="text-center">
                                                        {{x.saldo}}
                                                    </td>
                                                    <td class="text-center">
                                                        {{x.fechaPago}}
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" class="custom-checkbox" id={{x.noMovimiento}} name = {{x.saldo}} title={{x.fechaPago}}>
                                                            <label for={{x.CodFrac}}></label>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
										<div class="text-right"> 
										<button class="btn btn-default" ng-click="pagar()"><i class=" fa fa-credit-card "></i> Pagar</button>
											<nav>
											
												<ul class="pagination">
												  <li ng-click="previousPage()">
													<a id="previous"  aria-label="Previous">
													  <span aria-hidden="true">&laquo;</span>
													</a>
												  </li>
												  <li><a href="#">{{pagina}}</a></li>
												  <li ng-click="nextPage()">
													<a id="next"  aria-label="Next">
													  <span aria-hidden="true">&raquo;</span>
													</a>
												  </li>
												</ul>
											</nav>
											
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <!-- /. ROW  -->
                    </div>
                   
                </div>
                <!-- /. PAGE INNER  -->
            </div>
            <!-- /. PAGE WRAPPER  -->
        </div>
        <!-- /. WRAPPER  -->
        <!-- JS Scripts-->
        <!-- jQuery Js -->
        <script src="assets/js/jquery-1.10.2.js"></script>
        <!-- Bootstrap Js -->
        <script src="assets/js/bootstrap.min.js"></script>
        <!-- Metis Menu Js -->
        <script src="assets/js/jquery.metisMenu.js"></script>
        <!-- Morris Chart Js -->
        <script src="assets/js/morris/raphael-2.1.0.min.js"></script>
        <script src="assets/js/morris/morris.js"></script>
        <!-- Custom Js -->
        <script src="assets/js/custom-scripts.js"></script>

        <script src="assets/js/xml2json.min.js"></script>
		
		<script src="assets/js/socket.io.js"></script>

        <script>
              $(".frac_table").hide();
			  jQuery('#expText').keydown(function (e) {
        // Allow: backspace, delete, tab, escape, enter and .
        if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110]) !== -1 ||
             // Allow: Ctrl+A
            (e.keyCode == 65 && e.ctrlKey === true) ||
             // Allow: Ctrl+C
            (e.keyCode == 67 && e.ctrlKey === true) ||
             // not Allow: Ctrl+V
            (e.keyCode == 86 && e.ctrlKey === false) ||
             // Allow: home, end, left, right
            (e.keyCode >= 35 && e.keyCode <= 39)) {
                 // let it happen, don't do anything
                 return;
        }
        // Ensure that it is a number and stop the keypress
        if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            e.preventDefault();
        }
    });
	
			
	
	
              var app = angular.module('index', []).config(function($httpProvider){
              $httpProvider.defaults.useXDomain = true;
              delete $httpProvider.defaults.headers.common['X-Requested-With'];
              $httpProvider.defaults.timeout = 500000;
      });
              app.controller('index_ctrl', function($scope, $http) {
			  $scope.d = new Date();
			  var month = $scope.d.getMonth()+1;
			  if(month<10)
				month = "0"+month;
			  $scope.fechaActual = $scope.d.getDate()+""+month+""+$scope.d.getFullYear();
			  
			  var socket;
				socket = io.connect('https://rest-server-computo.herokuapp.com');
				socket.on('message', function (data) {
					if(data.message) {
						console.log(data.message);
					} else {
					
						
						console.log("There is a problem:", data);
					}
				});
			  $scope.enviarMensaje=function(fecha,exp, saldoCorriente, saldoVencido) {
			  
			  
						
					var mensaje = {
						saldoCorriente:saldoCorriente,
						saldoVencido:saldoVencido,
						fecha:fecha,
						expediente: exp,
						frac: $scope.myFrac.codFrac
					}
					
					
					socket.emit('updateMov', { mensaje:mensaje });
				};
			  
              $scope.pagina = 0;
             
			  $scope.allFracs = [];
			  
                     
                $scope.pagar = function(){
				
					var exp = $scope.expediente;
					var saldoCorriente = $scope.saldoCorriente;
					var saldoVencido=	$scope.saldoVencido ;
					
                              angular.forEach($('input:checked'), function(item) {

								  if (item.name != "0.0000")
								  {
									$scope.pagarCall(item.id, $scope.fechaActual, exp, saldoCorriente, saldoVencido);
									
								  }
								  else
									console.log(item.id);
                              });
                   };
                      


         

			$scope.pagarCall = function(mov, fecha,exp, saldoCorriente, saldoVencido){
				$http.get("http://soapjaxws.herokuapp.com/HelloService/pagar", {params: { arg0: mov }})
                   .success(function(response) {
                   var xmlText = response;
                   var x2js = new X2JS();
                   var jsonObj = x2js.xml_str2json( xmlText );
                  
                   $scope.getMovimientoInfo();
				   
                   })
                   .error(function(response) {$scope.pagarCall(); });
			};


         
          $scope.getAllFracs = function(){
				   $http.get("http://soapjaxws.herokuapp.com/HelloService/getAllFracs", {params: { }})
                   .success(function(response) {
                   var xmlText = response;
                   var x2js = new X2JS();
                   var jsonObj = x2js.xml_str2json( xmlText );
                   
                   $scope.allFracs= jsonObj.Envelope.Body.getAllFracsResponse.return;
				   $scope.myFrac = $scope.allFracs[0]; 
                   })
                   .error(function(response) {$scope.getAllFracs(); });

          };
		  $scope.buscar = function(){
		   $scope.pagina=0;
		   $scope.movimientos=[];
		   $scope.getMovimientoInfo();
		   
		  }
		  
		  $scope.getMovimientoInfo = function(){

		  console.log($scope.myFrac.codFrac);
				   var codFrac = $scope.myFrac.codFrac;
				   $scope.expediente = $("#expText").val();
				   var page = $scope.pagina;
				  
				  
				   
				   $http.get("http://soapjaxws.herokuapp.com/HelloService/getMovimientoInfo", {params: { arg0:codFrac,arg1:$scope.expediente, arg2:page}})
                   .success(function(response) {
                   var xmlText = response;
                   var x2js = new X2JS();
                   var jsonObj = x2js.xml_str2json( xmlText );
                   
						$scope.saldoCorriente = jsonObj.Envelope.Body.getMovimientoInfoResponse.return.SaldoCorriente;
						$scope.saldoVencido = jsonObj.Envelope.Body.getMovimientoInfoResponse.return.saldoVencido;
					    $scope.titular = jsonObj.Envelope.Body.getMovimientoInfoResponse.return.titular;
					    if(jsonObj.Envelope.Body.getMovimientoInfoResponse.return.movimientos != null)
						$scope.movimientos = jsonObj.Envelope.Body.getMovimientoInfoResponse.return.movimientos;
						
						$scope.enviarMensaje(fecha,exp, $scope.saldoCorriente, $scope.saldoVencido);
						
						
						
						alert("Sin resultados");
				   
                  console.log(jsonObj.Envelope.Body.getMovimientoInfoResponse);
				    
                   })
                   .error(function(response) {$scope.getAllFracs(); });

          };
          $scope.getAllFracs();
          
          $scope.nextPage = function(){
            
					$scope.movimientos=[];
                    $scope.pagina++;
                    $scope.getMovimientoInfo();
               
            };
            
            $scope.previousPage = function(){
            
                if ( $scope.pagina >0 ) {
					$scope.movimientos=[];
                    $scope.pagina--;
                    $scope.getMovimientoInfo();
                }
                else
                {
                    
                }
            };
          
          
          
          
          
          
          
          
          
  });

        </script>


    </body>

</html>